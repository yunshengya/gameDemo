<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>✨ 祝福弹窗 ✨</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      color: white;
      padding: 20px;
      position: relative;
    }

    .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('https://images.unsplash.com/photo-1533134486753-c833f0ed4866?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=2070&q=80') no-repeat center center;
      background-size: cover;
      z-index: -2;
    }

    .background-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: -1;
    }

    .popup-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }

    .popup {
      position: absolute;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 15px 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      font-weight: 500;
      transition: transform 0.3s, opacity 0.3s;
      pointer-events: all;
      cursor: pointer;
      min-width: 180px;
      white-space: nowrap;
      animation: float 3s ease-in-out infinite;
      border: 1px solid rgba(255, 255, 255, 0.18);
      will-change: transform, opacity;
    }

    .popup:hover {
      transform: scale(1.05);
      background: rgba(255, 255, 255, 0.35);
    }

    .popup-content {
      font-size: 18px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .popup-close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 18px;
      color: rgba(255, 255, 255, 0);
      cursor: pointer;
      transition: color 0.2s;
    }

    .popup:hover .popup-close {
      color: rgba(255, 255, 255, 0.7);
    }

    .popup-close:hover {
      color: white;
    }

    .popup-emoji {
      font-size: 24px;
      margin-bottom: 8px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .controls-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      transition: opacity 0.3s;
    }

    .auto-hide .controls-container {
      opacity: 0;
    }

    .auto-hide .controls-container:hover {
      opacity: 1;
    }

    .settings-btn {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .settings-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: rotate(90deg);
    }

    .controls {
      position: absolute;
      top: 60px;
      right: 0;
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 20px;
      display: none;
      flex-direction: column;
      gap: 15px;
      width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: opacity 0.5s;
    }

    /* 自定义滚动条样式 */
    .controls::-webkit-scrollbar {
      width: 8px;
    }

    .controls::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .controls::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .controls::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .controls-container:hover .controls {
      display: flex;
    }

    .controls.show {
      display: flex;
    }

    button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .counter {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 50px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: opacity 0.3s;
    }

    .auto-hide .counter {
      opacity: 0;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .control-input {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
      font-size: 14px;
    }

    .control-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
    }

    textarea.control-input {
      min-height: 80px;
      resize: vertical;
    }

    /* 自定义textarea滚动条 */
    textarea.control-input::-webkit-scrollbar {
      width: 6px;
    }

    textarea.control-input::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    textarea.control-input::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    textarea.control-input::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.3);
      transition: .4s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.toggle-slider {
      background-color: rgba(106, 17, 203, 0.8);
    }

    input:checked+.toggle-slider:before {
      transform: translateX(26px);
    }

    select.control-input {
      cursor: pointer;
    }

    .category-tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .category-tab {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .category-tab.active {
      background: rgba(255, 255, 255, 0.4);
      border-color: rgba(255, 255, 255, 0.7);
    }

    /* 文案管理模态框样式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    /* 模态框滚动条 */
    .modal-content::-webkit-scrollbar {
      width: 8px;
    }

    .modal-content::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .modal-content::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .message-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .message-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
    }

    .message-text {
      flex: 1;
    }

    .message-actions {
      display: flex;
      gap: 8px;
    }

    .message-action-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 4px;
      color: white;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .message-action-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .add-message-form {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .add-message-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 8px 12px;
      color: white;
    }

    .add-message-input:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.6);
    }

    .emoji-selector {
      display: flex;
      gap: 5px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .emoji-option {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      padding: 5px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .emoji-option:hover,
    .emoji-option.selected {
      background: rgba(255, 255, 255, 0.4);
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }

      50% {
        transform: translateY(-10px) rotate(1deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .liquid-effect {
      position: fixed;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
      animation: liquidMove 15s infinite linear;
      z-index: -1;
    }

    @keyframes liquidMove {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      button {
        padding: 10px 16px;
        font-size: 14px;
      }

      .controls {
        width: 280px;
      }

      .modal-content {
        width: 95%;
        padding: 15px;
      }
    }
  </style>
</head>

<body>
  <div class="background"></div>
  <div class="background-overlay"></div>
  <div class="liquid-effect"></div>

  <div class="popup-container" id="popupContainer"></div>

  <div class="controls-container">
    <div class="settings-btn">
      <i class="fas fa-cog"></i>
    </div>
    <div class="controls" id="controlsPanel">
      <div class="control-group">
        <div class="control-label">文案分类</div>
        <div class="category-tabs">
          <div class="category-tab active" data-category="all">全部</div>
          <div class="category-tab" data-category="hot">热门</div>
          <div class="category-tab" data-category="classic">古风</div>
          <div class="category-tab" data-category="romantic">浪漫</div>
          <div class="category-tab" data-category="encouraging">勉励</div>
          <div class="category-tab" data-category="modern">现代</div>
        </div>
        <button id="manageMessagesBtn" style="margin-top: 10px;">
          <i class="fas fa-edit"></i> 管理文案
        </button>
      </div>
      <div class="control-group">
        <div class="control-label">自定义文案</div>
        <textarea id="customMessages" class="control-input" placeholder="请输入自定义祝福语，每行一条"></textarea>
      </div>
      <div class="control-group">
        <div class="control-label">总弹窗数量</div>
        <input type="number" id="popupCount" class="control-input" value="100" min="1" max="1000">
      </div>
      <div class="control-group">
        <div class="control-label">生成速度 (毫秒)</div>
        <input type="number" id="popupSpeed" class="control-input" value="300" min="100" max="2000">
      </div>
      <div class="control-group">
        <div class="control-label">同时显示最大数量</div>
        <input type="number" id="maxVisible" class="control-input" value="100" min="1" max="500">
      </div>
      <button id="toggleBtn">
        <i class="fas fa-play"></i> 开始弹窗
      </button>
      <button id="clearBtn">
        <i class="fas fa-trash"></i> 清除所有
      </button>
      <div class="toggle-container">
        <div class="control-label">自动隐藏界面</div>
        <label class="toggle-switch">
          <input type="checkbox" id="autoHideToggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-container">
        <div class="control-label">显示计数器</div>
        <label class="toggle-switch">
          <input type="checkbox" id="counterToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="counter" id="counter">
    已生成: <span id="count">0</span> / <span id="totalCount">100</span> | 当前显示: <span id="visibleCount">0</span> / <span
      id="maxVisibleCount">100</span>
  </div>

  <!-- 文案管理模态框 -->
  <div class="modal" id="messageModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">文案管理 - <span id="modalCategoryName">全部</span></h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="message-list" id="messageList">
        <!-- 文案列表将通过JavaScript动态生成 -->
      </div>
      <div class="add-message-form">
        <input type="text" id="newMessageText" class="add-message-input" placeholder="输入新文案">
        <button id="addMessageBtn">添加</button>
      </div>
      <div class="emoji-selector" id="emojiSelector">
        <!-- 表情选项将通过JavaScript动态生成 -->
      </div>
    </div>
  </div>

  <script>
    let messageLibrary = {
      classic: [
        { text: "长风破浪会有时，直挂云帆济沧海", emoji: "🌊" },
        { text: "天生我材必有用，千金散尽还复来", emoji: "🌟" },
        { text: "会当凌绝顶，一览众山小", emoji: "⛰️" },
        { text: "千淘万漉虽辛苦，吹尽狂沙始到金", emoji: "💪" },
        { text: "宝剑锋从磨砺出，梅花香自苦寒来", emoji: "⚔️" },
        { text: "沉舟侧畔千帆过，病树前头万木春", emoji: "🌱" },
        { text: "山重水复疑无路，柳暗花明又一村", emoji: "🛣️" },
        { text: "欲穷千里目，更上一层楼", emoji: "🏢" },
        { text: "不经一番寒彻骨，怎得梅花扑鼻香", emoji: "❄️" },
        { text: "路漫漫其修远兮，吾将上下而求索", emoji: "🛣️" },
        { text: "人生得意须尽欢，莫使金樽空对月", emoji: "🍷" },
        { text: "天生傲骨怎能服输，壮志凌云永不言弃", emoji: "🦅" },
        { text: "海到无边天作岸，山登绝顶我为峰", emoji: "🌅" },
        { text: "雄关漫道真如铁，而今迈步从头越", emoji: "🚶" },
        { text: "千磨万击还坚劲，任尔东西南北风", emoji: "🎋" },
        { text: "少年易老学难成，一寸光阴不可轻", emoji: "⏳" },
        { text: "纸上得来终觉浅，绝知此事要躬行", emoji: "📚" },
        { text: "不畏浮云遮望眼，自缘身在最高层", emoji: "☁️" },
        { text: "咬定青山不放松，立根原在破岩中", emoji: "🎍" },
        { text: "春风得意马蹄疾，一日看尽长安花", emoji: "🐎" },
        // 新增50条激励性古诗
        { text: "莫愁前路无知己，天下谁人不识君", emoji: "🤝" },
        { text: "仰天大笑出门去，我辈岂是蓬蒿人", emoji: "😄" },
        { text: "黄沙百战穿金甲，不破楼兰终不还", emoji: "🛡️" },
        { text: "男儿何不带吴钩，收取关山五十州", emoji: "🗡️" },
        { text: "壮志饥餐胡虏肉，笑谈渴饮匈奴血", emoji: "💪" },
        { text: "生当作人杰，死亦为鬼雄", emoji: "👑" },
        { text: "粉身碎骨浑不怕，要留清白在人间", emoji: "⚪" },
        { text: "人生自古谁无死，留取丹心照汗青", emoji: "❤️" },
        { text: "老骥伏枥，志在千里", emoji: "🐎" },
        { text: "烈士暮年，壮心不已", emoji: "🔥" },
        { text: "乘风破浪会有时，直挂云帆济沧海", emoji: "⛵" },
        { text: "大鹏一日同风起，扶摇直上九万里", emoji: "🦅" },
        { text: "天生一个仙人洞，无限风光在险峰", emoji: "🏔️" },
        { text: "为有牺牲多壮志，敢教日月换新天", emoji: "☀️" },
        { text: "世上无难事，只要肯登攀", emoji: "🧗" },
        { text: "不到长城非好汉，屈指行程二万", emoji: "🏯" },
        { text: "红军不怕远征难，万水千山只等闲", emoji: "🚩" },
        { text: "今日长缨在手，何时缚住苍龙", emoji: "🐉" },
        { text: "宜将剩勇追穷寇，不可沽名学霸王", emoji: "⚔️" },
        { text: "天若有情天亦老，人间正道是沧桑", emoji: "🌍" },
        { text: "金猴奋起千钧棒，玉宇澄清万里埃", emoji: "🐒" },
        { text: "独有英雄驱虎豹，更无豪杰怕熊罴", emoji: "🐯" },
        { text: "四海翻腾云水怒，五洲震荡风雷激", emoji: "🌊" },
        { text: "可上九天揽月，可下五洋捉鳖", emoji: "🌙" },
        { text: "世上无难事，只怕有心人", emoji: "💡" },
        { text: "宝剑赠英雄，红粉送佳人", emoji: "⚔️" },
        { text: "十年磨一剑，霜刃未曾试", emoji: "🗡️" },
        { text: "宁为玉碎，不为瓦全", emoji: "💎" },
        { text: "疾风知劲草，板荡识诚臣", emoji: "🌾" },
        { text: "时危见臣节，世乱识忠良", emoji: "🛡️" },
        { text: "捐躯赴国难，视死忽如归", emoji: "🇨🇳" },
        { text: "丈夫志四海，万里犹比邻", emoji: "🌍" },
        { text: "刑天舞干戚，猛志固常在", emoji: "💪" },
        { text: "精卫衔微木，将以填沧海", emoji: "🐦" },
        { text: "少壮不努力，老大徒伤悲", emoji: "📚" },
        { text: "盛年不重来，一日难再晨", emoji: "🌅" },
        { text: "及时当勉励，岁月不待人", emoji: "⏰" },
        { text: "志士惜日短，愁人知夜长", emoji: "🕯️" },
        { text: "莫等闲，白了少年头，空悲切", emoji: "👨" },
        { text: "三十功名尘与土，八千里路云和月", emoji: "🌙" },
        { text: "壮心未与年俱老，死去犹能作鬼雄", emoji: "👻" },
        { text: "位卑未敢忘忧国，事定犹须待阖棺", emoji: "🇨🇳" },
        { text: "出师未捷身先死，长使英雄泪满襟", emoji: "😢" },
        { text: "苟利国家生死以，岂因祸福避趋之", emoji: "🛡️" },
        { text: "我自横刀向天笑，去留肝胆两昆仑", emoji: "🗡️" },
        { text: "拼将十万头颅血，须把乾坤力挽回", emoji: "💥" },
        { text: "一腔热血勤珍重，洒去犹能化碧涛", emoji: "💧" },
        { text: "面壁十年图破壁，难酬蹈海亦英雄", emoji: "🧱" },
        { text: "为中华之崛起而读书", emoji: "📖" }
      ],
      romantic: [
        { text: "执子之手与子偕老", emoji: "👫" },
        { text: "愿得一人心白首不相离", emoji: "💞" },
        { text: "心有灵犀一点通", emoji: "💘" },
        { text: "在天愿作比翼鸟", emoji: "🐦" },
        { text: "今生有你万事足", emoji: "🥰" },
        { text: "只愿君心似我心", emoji: "💑" },
        { text: "你是我的光与热", emoji: "✨" },
        { text: "爱你如初不改初心", emoji: "💖" },
        { text: "相濡以沫共度余生", emoji: "🌊" },
        { text: "你是我此生最美的风景", emoji: "🏞️" },
        // 新增50条激励性浪漫文案
        { text: "爱情让平凡的日子闪闪发光", emoji: "✨" },
        { text: "因为有你，我成为了更好的自己", emoji: "🌟" },
        { text: "真爱能战胜一切困难", emoji: "🛡️" },
        { text: "我们的爱是彼此最坚强的后盾", emoji: "💪" },
        { text: "携手同行，共创美好未来", emoji: "🤝" },
        { text: "你让我相信爱情的力量", emoji: "💖" },
        { text: "真爱无畏风雨，勇往直前", emoji: "🌧️" },
        { text: "我们的故事值得被永远铭记", emoji: "📖" },
        { text: "你是我奋斗的最大动力", emoji: "⚡" },
        { text: "因为有爱，所以无所畏惧", emoji: "🦁" },
        { text: "爱情让我们变得更勇敢", emoji: "🛡️" },
        { text: "你是我生命中最美的奇迹", emoji: "🎁" },
        { text: "真爱能治愈一切伤痛", emoji: "💊" },
        { text: "我们的爱会创造无限可能", emoji: "∞" },
        { text: "你让我看到了更广阔的世界", emoji: "🌍" },
        { text: "爱情是最好的成长催化剂", emoji: "🧪" },
        { text: "我们的未来充满希望和光明", emoji: "🔆" },
        { text: "真爱让我们彼此成就", emoji: "🏆" },
        { text: "你是我最珍贵的财富", emoji: "💎" },
        { text: "爱情让平凡变得非凡", emoji: "🎭" },
        { text: "我们的爱会越来越深厚", emoji: "📈" },
        { text: "你让我相信永恒的存在", emoji: "⏳" },
        { text: "真爱能跨越一切障碍", emoji: "🚧" },
        { text: "我们的故事才刚刚开始", emoji: "🎬" },
        { text: "你是我前进的方向", emoji: "🧭" },
        { text: "爱情让我们无所不能", emoji: "🦸" },
        { text: "我们的爱会温暖整个世界", emoji: "🌡️" },
        { text: "你是我最坚实的依靠", emoji: "🏗️" },
        { text: "真爱让我们永不言弃", emoji: "🚩" },
        { text: "我们的未来由我们创造", emoji: "🔨" },
        { text: "你让我看到了无限可能", emoji: "♾️" },
        { text: "爱情是最好的精神食粮", emoji: "🍎" },
        { text: "我们的爱会照亮前路", emoji: "💡" },
        { text: "你是我最强大的动力", emoji: "⚙️" },
        { text: "真爱让我们勇攀高峰", emoji: "🏔️" },
        { text: "我们的故事激励着彼此", emoji: "📣" },
        { text: "你让我相信梦想会成真", emoji: "🌠" },
        { text: "爱情让生活充满色彩", emoji: "🎨" },
        { text: "我们的爱会创造奇迹", emoji: "✨" },
        { text: "你是我最美好的遇见", emoji: "🎯" },
        { text: "真爱让我们超越自我", emoji: "🚀" },
        { text: "我们的未来无限光明", emoji: "🔆" },
        { text: "你让我变得无所畏惧", emoji: "🦸" },
        { text: "爱情是最好的心灵良药", emoji: "💊" },
        { text: "我们的爱会感动天地", emoji: "🌍" },
        { text: "你是我最珍贵的礼物", emoji: "🎁" },
        { text: "真爱让我们永葆青春", emoji: "👶" },
        { text: "我们的故事永不完结", emoji: "📚" },
        { text: "你让我相信真爱的力量", emoji: "💪" },
        { text: "爱情让生命更有意义", emoji: "💫" }
      ],
      encouraging: [
        { text: "你比想象中更强大", emoji: "💪" },
        { text: "坚持就是胜利", emoji: "🏆" },
        { text: "未来可期请别放弃", emoji: "🔮" },
        { text: "每一天都是新的开始", emoji: "🌅" },
        { text: "你值得所有美好", emoji: "✨" },
        { text: "勇敢追逐你的梦想", emoji: "🚀" },
        { text: "阳光总在风雨后", emoji: "🌈" },
        { text: "你是独一无二的存在", emoji: "🌟" },
        { text: "微笑面对每一天", emoji: "😊" },
        { text: "困难只是暂时的", emoji: "⏳" },
        // 新增50条激励性鼓励文案
        { text: "你的潜力超乎你的想象", emoji: "🚀" },
        { text: "每一次努力都在积累成功", emoji: "📈" },
        { text: "相信自己，你能做到", emoji: "👍" },
        { text: "挫折是成功的垫脚石", emoji: "🪜" },
        { text: "你的坚持终将美好", emoji: "🌅" },
        { text: "不要被困难定义，要定义困难", emoji: "🎯" },
        { text: "你正在成为更好的自己", emoji: "🌟" },
        { text: "今天的汗水是明天的辉煌", emoji: "💦" },
        { text: "你的努力不会被辜负", emoji: "⚖️" },
        { text: "勇敢迈出第一步就是成功", emoji: "👣" },
        { text: "你的价值不需要他人定义", emoji: "💎" },
        { text: "每一次尝试都离成功更近", emoji: "🎯" },
        { text: "你是自己人生的主角", emoji: "🎬" },
        { text: "困难只是暂时的，成就是永恒的", emoji: "⏳" },
        { text: "你的独特就是你的力量", emoji: "🦄" },
        { text: "不要让恐惧阻止你前进", emoji: "🚫" },
        { text: "你比自己想象的更坚强", emoji: "💪" },
        { text: "成功属于永不放弃的人", emoji: "🚩" },
        { text: "你的梦想值得你全力以赴", emoji: "🎯" },
        { text: "每一次跌倒都是为了更好的站起", emoji: "🔄" },
        { text: "你是生命中最美的风景", emoji: "🏞️" },
        { text: "坚持到底就是胜利", emoji: "🏁" },
        { text: "你的努力正在改变未来", emoji: "🔮" },
        { text: "不要低估自己的潜力", emoji: "📊" },
        { text: "你是无限可能的创造者", emoji: "♾️" },
        { text: "勇敢追求心中的梦想", emoji: "💫" },
        { text: "你的坚持感动着世界", emoji: "🌍" },
        { text: "每一次进步都值得庆祝", emoji: "🎉" },
        { text: "你是希望的播种者", emoji: "🌱" },
        { text: "不要让任何人否定你的价值", emoji: "❌" },
        { text: "你的光芒终将被看见", emoji: "💡" },
        { text: "坚持梦想，永不放弃", emoji: "🌠" },
        { text: "你是勇敢的追梦人", emoji: "🦸" },
        { text: "每一次努力都在塑造更好的你", emoji: "🔨" },
        { text: "你的热情能点燃世界", emoji: "🔥" },
        { text: "不要害怕失败，害怕不尝试", emoji: "😨" },
        { text: "你是生命的奇迹", emoji: "✨" },
        { text: "坚持信念，终见光明", emoji: "💡" },
        { text: "你的勇气感染着他人", emoji: "🦠" },
        { text: "每一次挑战都是成长的机会", emoji: "🌱" },
        { text: "你是命运的掌舵者", emoji: "🧭" },
        { text: "不要被困难吓倒，要吓倒困难", emoji: "👻" },
        { text: "你的坚持终将开花结果", emoji: "🌺" },
        { text: "勇敢做自己，无需他人认可", emoji: "👤" },
        { text: "你是希望的象征", emoji: "🕊️" },
        { text: "每一次努力都在创造历史", emoji: "📜" },
        { text: "你的梦想正在实现", emoji: "🎯" },
        { text: "不要停止前进的脚步", emoji: "👣" },
        { text: "你是光明的使者", emoji: "🔦" },
        { text: "坚持到底，胜利在望", emoji: "🏆" }
      ],
      modern: [
        { text: "今天也要闪闪发光", emoji: "✨" },
        { text: "你是人间值得", emoji: "💫" },
        { text: "生活明朗万物可爱", emoji: "🐾" },
        { text: "保持热爱奔赴山海", emoji: "🗺️" },
        { text: "最好的状态是未来可期", emoji: "🔮" },
        { text: "把耐心留住惊喜慢慢来", emoji: "🕰️" },
        { text: "你逆光而来配得美好", emoji: "👑" },
        { text: "世事千帆过前方终会温柔", emoji: "🌙" },
        { text: "知足且坚定温柔且上进", emoji: "🌱" },
        { text: "万物皆有裂痕那是光照进来的地方", emoji: "💡" },
        // 新增50条激励性现代文案
        { text: "你的努力正在被世界看见", emoji: "👀" },
        { text: "勇敢做自己，世界因你不同", emoji: "🌍" },
        { text: "每一次坚持都在改写命运", emoji: "📝" },
        { text: "你是新时代的追光者", emoji: "🔦" },
        { text: "梦想不会逃跑，会逃跑的永远是自己", emoji: "🏃" },
        { text: "你的独特是最大的竞争力", emoji: "🎯" },
        { text: "不要被定义，要重新定义", emoji: "🔄" },
        { text: "你是自己人生的CEO", emoji: "👨‍💼" },
        { text: "坚持热爱，终会发光", emoji: "💎" },
        { text: "你的价值由自己决定", emoji: "⚖️" },
        { text: "勇敢打破舒适区", emoji: "🚧" },
        { text: "你是无限可能的代名词", emoji: "∞" },
        { text: "每一次尝试都在拓展边界", emoji: "🗺️" },
        { text: "不要等待机会，要创造机会", emoji: "🔨" },
        { text: "你是生活的艺术家", emoji: "🎨" },
        { text: "坚持做对的事，时间会证明一切", emoji: "⏰" },
        { text: "你的潜力需要被激发", emoji: "⚡" },
        { text: "不要害怕改变，要拥抱变化", emoji: "🔄" },
        { text: "你是未来的建造者", emoji: "🏗️" },
        { text: "每一次突破都在创造历史", emoji: "📜" },
        { text: "勇敢发声，你的声音很重要", emoji: "🗣️" },
        { text: "你是希望的传播者", emoji: "📡" },
        { text: "坚持初心，方得始终", emoji: "🎯" },
        { text: "你的能量超乎想象", emoji: "🔋" },
        { text: "不要被标签限制，要打破标签", emoji: "🏷️" },
        { text: "你是时代的弄潮儿", emoji: "🌊" },
        { text: "每一次努力都在推动进步", emoji: "📈" },
        { text: "勇敢追梦，不负韶华", emoji: "🌠" },
        { text: "你是光明的引领者", emoji: "💡" },
        { text: "坚持信念，终见彩虹", emoji: "🌈" },
        { text: "你的创造力改变世界", emoji: "🎨" },
        { text: "不要畏惧失败，要感谢尝试", emoji: "🙏" },
        { text: "你是梦想的实现者", emoji: "🌟" },
        { text: "每一次坚持都在积累力量", emoji: "💪" },
        { text: "勇敢创新，敢于不同", emoji: "💡" },
        { text: "你是希望的种子", emoji: "🌱" },
        { text: "坚持到底，终见曙光", emoji: "🌅" },
        { text: "你的热情感染他人", emoji: "🔥" },
        { text: "不要被困难吓倒，要战胜困难", emoji: "⚔️" },
        { text: "你是生命的勇士", emoji: "🛡️" },
        { text: "每一次努力都在书写传奇", emoji: "📖" },
        { text: "勇敢前行，无所畏惧", emoji: "🚶" },
        { text: "你是希望的灯塔", emoji: "🗼" },
        { text: "坚持梦想，终会实现", emoji: "🎯" },
        { text: "你的坚持感动人心", emoji: "💖" },
        { text: "不要停止学习，要持续成长", emoji: "📚" },
        { text: "你是时代的见证者", emoji: "👁️" },
        { text: "每一次努力都在创造价值", emoji: "💰" },
        { text: "勇敢爱，勇敢生活", emoji: "❤️" },
        { text: "你是最美的风景", emoji: "🏞️" }
      ],
      hot: [
        { text: "你值得被爱", emoji: "💖" },
        { text: "允许自己休息", emoji: "🛌" },
        { text: "别苛责自己", emoji: "🕊️" },
        { text: "好好吃饭睡觉", emoji: "🍚🌙" },
        { text: "你已足够好", emoji: "🌟" },
        { text: "慢一点也没关系", emoji: "🐌" },
        { text: "情绪需要出口", emoji: "💧" },
        { text: "爱自己优先", emoji: "🫶" },
        { text: "不必事事完美", emoji: "✨" },
        { text: "今天辛苦了", emoji: "🍵" },
        { text: "给自己一个拥抱", emoji: "🤗" },
        { text: "你的感受重要", emoji: "❤️" },
        { text: "别透支自己", emoji: "🔋" },
        { text: "静下来听听心", emoji: "🧘" },
        { text: "你本就完整", emoji: "☯️" },
        { text: "停一停也可以", emoji: "⏸️" },
        { text: "别怕说不", emoji: "🚫" },
        { text: "你值得轻松", emoji: "🌤️" },
        { text: "内心柔软很美", emoji: "🌸" },
        { text: "接纳不完美的你", emoji: "🌱" },
        // 新增热门短文案
        { text: "天天开心", emoji: "😊" },
        { text: "谢谢你", emoji: "🙏" },
        { text: "做最棒的自己", emoji: "💪" },
        { text: "不要熬夜", emoji: "🌙" },
        { text: "没有烦恼", emoji: "🌈" },
        { text: "好好吃饭", emoji: "🍚" },
        { text: "世界很大 开心第一", emoji: "🌍" },
        { text: "可爱", emoji: "🐰" },
        { text: "有趣", emoji: "🎭" },
        { text: "真诚", emoji: "💎" },
        { text: "温柔", emoji: "🌷" },
        { text: "游戏很厉害", emoji: "🎮" },
        { text: "情绪稳定", emoji: "⚖️" },
        { text: "会回消息", emoji: "📱" },
        { text: "你本来就是一个很好的人", emoji: "✨" },
        { text: "你很特别", emoji: "⭐" },
        { text: "保持微笑", emoji: "😄" },
        { text: "你很优秀", emoji: "🏆" },
        { text: "相信自己", emoji: "👍" },
        { text: "你很勇敢", emoji: "🦸" },
        { text: "一切都会好的", emoji: "🌤️" },
        { text: "你很努力", emoji: "💪" },
        { text: "放松一下", emoji: "🎵" },
        { text: "你很温暖", emoji: "☀️" },
        { text: "慢慢来", emoji: "🐢" },
        { text: "你很聪明", emoji: "💡" },
        { text: "照顾好自己", emoji: "❤️" },
        { text: "你很坚强", emoji: "🛡️" },
        { text: "别太累", emoji: "💤" },
        { text: "你很善良", emoji: "🕊️" },
        { text: "开心最重要", emoji: "🎉" },
        { text: "你很独特", emoji: "🦄" },
        { text: "享受当下", emoji: "⏳" },
        { text: "你很棒", emoji: "👏" },
        { text: "别想太多", emoji: "🧠" },
        { text: "你很重要", emoji: "💎" },
        { text: "深呼吸", emoji: "💨" },
        { text: "你很可爱", emoji: "🐶" },
        { text: "放轻松", emoji: "🌊" },
        { text: "你很美好", emoji: "🌸" },
        { text: "笑一笑", emoji: "😊" },
        { text: "你很珍贵", emoji: "💎" },
        { text: "别着急", emoji: "⏰" },
        { text: "你很出色", emoji: "🎯" },
        { text: "休息一下", emoji: "🛋️" },
        { text: "你很了不起", emoji: "🌟" },
        { text: "慢慢走", emoji: "🚶" },
        { text: "你很耀眼", emoji: "✨" },
        { text: "别担心", emoji: "🤗" },
        { text: "你很完美", emoji: "💫" },
        { text: "放空一下", emoji: "☁️" },
        { text: "你很强大", emoji: "⚡" },
        { text: "享受生活", emoji: "🎨" },
        { text: "你很温柔", emoji: "🌙" },
        { text: "别放弃", emoji: "🚩" },
        { text: "你很美丽", emoji: "🌹" },
        { text: "向前看", emoji: "👀" },
        { text: "你很勇敢", emoji: "🦁" },
        { text: "活在当下", emoji: "🎯" },
        { text: "你很坚强", emoji: "💎" },
        { text: "别比较", emoji: "⚖️" },
        { text: "你很优秀", emoji: "🎓" },
        { text: "做自己", emoji: "👤" },
        { text: "你很温暖", emoji: "🔥" },
        { text: "爱自己", emoji: "💝" },
        { text: "你很特别", emoji: "🎁" },
        { text: "别勉强", emoji: "🕊️" },
        { text: "你很美好", emoji: "🌈" },
        { text: "慢慢来", emoji: "🐌" },
        { text: "你很珍贵", emoji: "💎" },
        { text: "开心点", emoji: "😄" },
        { text: "你很棒", emoji: "👍" },
        { text: "放松点", emoji: "🌴" },
        { text: "你很优秀", emoji: "🏅" },
        { text: "别紧张", emoji: "🧘" },
        { text: "你很独特", emoji: "🦋" },
        { text: "享受此刻", emoji: "⏰" },
        { text: "你很美好", emoji: "🌺" },
        { text: "别焦虑", emoji: "🌊" },
        { text: "你很完美", emoji: "💫" },
        { text: "深呼吸", emoji: "💨" },
        { text: "你很耀眼", emoji: "✨" },
        { text: "放轻松", emoji: "🎈" },
        { text: "你很强大", emoji: "💪" },
        { text: "慢慢来", emoji: "🐢" },
        { text: "你很温暖", emoji: "☀️" },
        { text: "别着急", emoji: "⏳" },
        { text: "你很珍贵", emoji: "💎" },
        { text: "休息下", emoji: "🛌" },
        { text: "你很美好", emoji: "🌸" },
        { text: "开心笑", emoji: "😊" },
        { text: "你很特别", emoji: "⭐" },
        { text: "放空下", emoji: "☁️" },
        { text: "你很完美", emoji: "💖" },
        { text: "慢慢走", emoji: "🚶" },
        { text: "你很耀眼", emoji: "🌟" },
        { text: "别担心", emoji: "🤗" },
        { text: "你很强大", emoji: "⚡" },
        { text: "享受吧", emoji: "🎉" },
        { text: "你很温暖", emoji: "🔥" },
        { text: "爱自己", emoji: "💝" },
        { text: "你很优秀", emoji: "🎯" },
        { text: "做自己", emoji: "👤" },
        { text: "你很美好", emoji: "🌈" },
        { text: "别比较", emoji: "⚖️" },
        { text: "你很珍贵", emoji: "💎" },
        { text: "向前看", emoji: "👀" },
        { text: "你很完美", emoji: "💫" },
        { text: "活在当下", emoji: "🎯" }
      ]
    };
    // 扩展消息数组到200个以上
    let allMessages = [];
    Object.values(messageLibrary).forEach(category => {
      allMessages = allMessages.concat(category);
    });

    // 确保至少有200条消息
    while (allMessages.length < 200) {
      allMessages = allMessages.concat(allMessages);
    }
    allMessages = allMessages.slice(0, 200);

    // 颜色数组 - 柔和渐变色
    const colors = [
      "linear-gradient(135deg, rgba(255,154,162,0.8) 0%, rgba(255,183,178,0.8) 100%)",
      "linear-gradient(135deg, rgba(255,218,193,0.8) 0%, rgba(226,240,203,0.8) 100%)",
      "linear-gradient(135deg, rgba(181,234,215,0.8) 0%, rgba(199,206,234,0.8) 100%)",
      "linear-gradient(135deg, rgba(248,177,149,0.8) 0%, rgba(246,114,128,0.8) 100%)",
      "linear-gradient(135deg, rgba(192,108,132,0.8) 0%, rgba(108,91,123,0.8) 100%)",
      "linear-gradient(135deg, rgba(106,17,203,0.8) 0%, rgba(37,117,252,0.8) 100%)",
      "linear-gradient(135deg, rgba(255,107,107,0.8) 0%, rgba(255,181,70,0.8) 100%)",
      "linear-gradient(135deg, rgba(72,198,239,0.8) 0%, rgba(111,134,214,0.8) 100%)",
      "linear-gradient(135deg, rgba(253,203,110,0.8) 0%, rgba(213,153,196,0.8) 100%)",
      "linear-gradient(135deg, rgba(116,235,213,0.8) 0%, rgba(159,172,230,0.8) 100%)"
    ];

    // 常用表情
    const commonEmojis = ["😄", "🙏", "💪", "🌙", "🌈", "🍚", "🌍", "😊", "🤹", "❤️", "🌸", "🎮", "🧘", "📱", "🌟", "🌤️", "🌅", "💫", "⏳", "🍃", "🌿", "✨", "👫", "💞", "🐯", "💑", "🎑", "🌲", "💘", "🌹", "💍", "🌄", "☀️", "💊", "🏠", "⛰️", "🍵", "🍂", "⚡", "💡", "🌱", "🛣️", "⭐", "🌬️", "🛑", "👑", "🔮", "🎁", "🍀", "📦", "✅", "🎯", "🔄", "💃", "🔋", "🎆", "🍬", "💅", "📅"];

    // DOM元素
    const popupContainer = document.getElementById('popupContainer');
    const toggleBtn = document.getElementById('toggleBtn');
    const clearBtn = document.getElementById('clearBtn');
    const countElement = document.getElementById('count');
    const totalCountElement = document.getElementById('totalCount');
    const visibleCountElement = document.getElementById('visibleCount');
    const maxVisibleCountElement = document.getElementById('maxVisibleCount');
    const popupCountInput = document.getElementById('popupCount');
    const popupSpeedInput = document.getElementById('popupSpeed');
    const maxVisibleInput = document.getElementById('maxVisible');
    const autoHideToggle = document.getElementById('autoHideToggle');
    const counterToggle = document.getElementById('counterToggle');
    const counter = document.getElementById('counter');
    const controlsPanel = document.getElementById('controlsPanel');
    const customMessagesInput = document.getElementById('customMessages');
    const categoryTabs = document.querySelectorAll('.category-tab');
    const manageMessagesBtn = document.getElementById('manageMessagesBtn');
    const messageModal = document.getElementById('messageModal');
    const modalCategoryName = document.getElementById('modalCategoryName');
    const messageList = document.getElementById('messageList');
    const newMessageText = document.getElementById('newMessageText');
    const addMessageBtn = document.getElementById('addMessageBtn');
    const emojiSelector = document.getElementById('emojiSelector');
    const closeModal = document.querySelector('.close-modal');

    // 状态变量
    let popupInterval;
    let popupCount = 0;
    let visiblePopupCount = 0;
    let isRunning = false;
    let totalPopupCount = 100;
    let popupSpeed = 300;
    let maxVisiblePopups = 100;
    let hideTimeout;
    let currentCategory = 'all';
    let currentMessages = [...allMessages];
    let selectedEmoji = "😊";
    let managingCategory = 'all';
    let lastFrameTime = 0;
    const frameInterval = 16; // 约60fps
    // 保存设置到本地存储
    function saveSettings () {
      const settings = {
        currentCategory: currentCategory,
        popupCount: document.getElementById('popupCount').value,
        popupSpeed: document.getElementById('popupSpeed').value,
        maxVisible: document.getElementById('maxVisible').value,
        autoHide: document.getElementById('autoHideToggle').checked,
        counterVisible: document.getElementById('counterToggle').checked,
        customMessages: document.getElementById('customMessages').value
      };
      localStorage.setItem('blessingPopupSettings', JSON.stringify(settings));
    }

    // 从本地存储加载设置
    function loadSettings () {
      const saved = localStorage.getItem('blessingPopupSettings');
      if (saved) {
        const settings = JSON.parse(saved);

        // 恢复分类选择
        if (settings.currentCategory) {
          currentCategory = settings.currentCategory;
          // 更新分类标签状态
          categoryTabs.forEach(tab => {
            if (tab.dataset.category === currentCategory) {
              tab.classList.add('active');
            } else {
              tab.classList.remove('active');
            }
          });
        }

        // 恢复数值设置
        if (settings.popupCount) document.getElementById('popupCount').value = settings.popupCount;
        if (settings.popupSpeed) document.getElementById('popupSpeed').value = settings.popupSpeed;
        if (settings.maxVisible) document.getElementById('maxVisible').value = settings.maxVisible;

        // 恢复开关状态
        if (settings.autoHide !== undefined) {
          document.getElementById('autoHideToggle').checked = settings.autoHide;
          toggleAutoHide(); // 应用设置
        }
        if (settings.counterVisible !== undefined) {
          document.getElementById('counterToggle').checked = settings.counterVisible;
          toggleCounter(); // 应用设置
        }

        // 恢复自定义消息
        if (settings.customMessages) {
          document.getElementById('customMessages').value = settings.customMessages;
        }

        // 更新当前消息列表
        updateCurrentMessages();
      }
    }
    // 初始化
    function init () {
      loadSettings(); // 加载保存的设置
      updateTotalCountDisplay();
      updateVisibleCount();
      toggleCounter();
      setupEventListeners();
      populateEmojiSelector();

      // 初始创建几个弹窗
      for (let i = 0; i < 5; i++) {
        setTimeout(() => {
          createPopup();
        }, i * 300);
      }
    }

    // 设置事件监听器
    function setupEventListeners () {
      // 使用事件委托处理弹窗点击
      popupContainer.addEventListener('click', function (e) {
        const popup = e.target.closest('.popup');
        if (!popup) return;

        if (e.target.classList.contains('popup-close')) {
          popup.remove();
          visiblePopupCount--;
          updateVisibleCount();
        } else {
          // 点击弹窗内容时放大显示
          popup.style.transform = 'scale(1.2)';
          popup.style.zIndex = '1000';
          setTimeout(() => {
            popup.style.transform = 'scale(1)';
            popup.style.zIndex = '100';
          }, 500);
        }
      });

      // 控制按钮事件
      toggleBtn.addEventListener('click', function () {
        if (isRunning) {
          pausePopups();
        } else {
          startPopups();
        }
      });

      clearBtn.addEventListener('click', clearPopups);
      autoHideToggle.addEventListener('change', toggleAutoHide);
      counterToggle.addEventListener('change', toggleCounter);

      // 分类标签点击事件 - 修复：确保切换分类时更新消息列表
      // 分类标签点击事件
      categoryTabs.forEach(tab => {
        tab.addEventListener('click', function () {
          switchCategory(this.dataset.category);
          saveSettings(); // 保存设置
        });
      });

      // 输入框变化时保存设置
      document.getElementById('popupCount').addEventListener('change', saveSettings);
      document.getElementById('popupSpeed').addEventListener('change', saveSettings);
      document.getElementById('maxVisible').addEventListener('change', saveSettings);
      document.getElementById('customMessages').addEventListener('input', saveSettings);

      // 开关变化时保存设置
      autoHideToggle.addEventListener('change', function () {
        toggleAutoHide();
        saveSettings();
      });

      counterToggle.addEventListener('change', function () {
        toggleCounter();
        saveSettings();
      });

      // 自定义消息变化时更新当前消息列表
      customMessagesInput.addEventListener('input', function () {
        updateCurrentMessages();
      });

      // 设置面板显示延迟
      const controlsContainer = document.querySelector('.controls-container');
      controlsContainer.addEventListener('mouseenter', function () {
        clearTimeout(hideTimeout);
        controlsPanel.style.display = 'flex';
      });

      controlsContainer.addEventListener('mouseleave', function () {
        hideTimeout = setTimeout(function () {
          controlsPanel.style.display = 'none';
        }, 500);
      });

      // 文案管理相关事件
      manageMessagesBtn.addEventListener('click', openMessageModal);
      closeModal.addEventListener('click', closeMessageModal);
      addMessageBtn.addEventListener('click', addNewMessage);

      // 点击模态框外部关闭
      window.addEventListener('click', function (e) {
        if (e.target === messageModal) {
          closeMessageModal();
        }
      });
    }

    // 填充表情选择器
    function populateEmojiSelector () {
      emojiSelector.innerHTML = '';
      commonEmojis.forEach(emoji => {
        const emojiOption = document.createElement('div');
        emojiOption.className = 'emoji-option';
        emojiOption.textContent = emoji;
        emojiOption.addEventListener('click', function () {
          // 移除之前选中的表情
          document.querySelectorAll('.emoji-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          // 选中当前表情
          this.classList.add('selected');
          selectedEmoji = emoji;
        });
        emojiSelector.appendChild(emojiOption);
      });

      // 默认选中第一个表情
      if (emojiSelector.firstChild) {
        emojiSelector.firstChild.classList.add('selected');
      }
    }

    // 打开文案管理模态框
    function openMessageModal () {
      managingCategory = currentCategory;
      modalCategoryName.textContent = getCategoryName(managingCategory);
      renderMessageList();
      messageModal.style.display = 'block';
    }

    // 关闭文案管理模态框
    function closeMessageModal () {
      messageModal.style.display = 'none';
    }

    // 获取分类名称
    function getCategoryName (category) {
      const names = {
        'all': '全部',
        'classic': '古风',
        'hot': '热门',
        'romantic': '浪漫',
        'encouraging': '勉励',
        'modern': '现代'
      };
      return names[category] || category;
    }

    // 渲染文案列表
    function renderMessageList () {
      messageList.innerHTML = '';
      let messages = [];

      if (managingCategory === 'all') {
        // 显示所有分类的文案
        Object.values(messageLibrary).forEach(categoryMessages => {
          messages = messages.concat(categoryMessages);
        });
      } else {
        messages = [...(messageLibrary[managingCategory] || [])];
      }

      messages.forEach((message, index) => {
        const messageItem = document.createElement('div');
        messageItem.className = 'message-item';
        messageItem.innerHTML = `
                    <div class="message-text">${message.emoji} ${message.text}</div>
                    <div class="message-actions">
                        <button class="message-action-btn edit-message" data-index="${index}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="message-action-btn delete-message" data-index="${index}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
        messageList.appendChild(messageItem);
      });

      // 添加编辑和删除事件
      document.querySelectorAll('.edit-message').forEach(btn => {
        btn.addEventListener('click', function () {
          const index = parseInt(this.dataset.index);
          editMessage(index);
        });
      });

      document.querySelectorAll('.delete-message').forEach(btn => {
        btn.addEventListener('click', function () {
          const index = parseInt(this.dataset.index);
          deleteMessage(index);
        });
      });
    }

    // 编辑文案
    function editMessage (index) {
      let messages = [];

      if (managingCategory === 'all') {
        // 获取所有分类的文案
        Object.values(messageLibrary).forEach(categoryMessages => {
          messages = messages.concat(categoryMessages);
        });
      } else {
        messages = messageLibrary[managingCategory] || [];
      }

      if (index >= 0 && index < messages.length) {
        const message = messages[index];
        const newText = prompt('编辑文案:', message.text);
        if (newText !== null && newText.trim() !== '') {
          message.text = newText.trim();
          renderMessageList();
          updateCurrentMessages();
        }
      }
    }

    // 删除文案
    function deleteMessage (index) {
      if (confirm('确定要删除这条文案吗？')) {
        if (managingCategory === 'all') {
          // 从所有分类中删除这条文案
          Object.keys(messageLibrary).forEach(category => {
            const messages = messageLibrary[category];
            if (index < messages.length) {
              messages.splice(index, 1);
            }
          });
        } else {
          const messages = messageLibrary[managingCategory];
          if (messages && index < messages.length) {
            messages.splice(index, 1);
          }
        }

        renderMessageList();
        updateCurrentMessages();
      }
    }

    // 添加新文案
    function addNewMessage () {
      const text = newMessageText.value.trim();
      if (text === '') {
        alert('请输入文案内容');
        return;
      }

      const newMessage = {
        text: text,
        emoji: selectedEmoji
      };

      if (managingCategory === 'all') {
        // 如果没有默认分类，创建一个
        if (!messageLibrary.default) {
          messageLibrary.default = [];
        }
        messageLibrary.default.push(newMessage);
      } else {
        // 确保目标分类存在
        if (!messageLibrary[managingCategory]) {
          messageLibrary[managingCategory] = [];
        }
        messageLibrary[managingCategory].push(newMessage);
      }

      newMessageText.value = '';
      renderMessageList();
      updateCurrentMessages();
    }

    // 更新总弹窗数显示
    function updateTotalCountDisplay () {
      totalCountElement.textContent = totalPopupCount;
      maxVisibleCountElement.textContent = maxVisiblePopups;
    }

    // 切换分类 - 修复：确保正确更新当前消息列表
    function switchCategory (category) {
      currentCategory = category;

      // 更新标签状态
      categoryTabs.forEach(tab => {
        if (tab.dataset.category === category) {
          tab.classList.add('active');
        } else {
          tab.classList.remove('active');
        }
      });

      updateCurrentMessages();

      // 如果正在运行，重新开始以确保使用新的分类
      if (isRunning) {
        pausePopups();
        startPopups();
      }
    }

    // 更新当前消息列表 - 修复：确保正确合并分类消息和自定义消息
    function updateCurrentMessages () {
      const customMessages = getCustomMessages();

      if (customMessages.length > 0) {
        // 如果有自定义消息，只使用自定义消息
        currentMessages = customMessages;
      } else if (currentCategory === 'all') {
        // 使用所有分类的消息
        currentMessages = [];
        Object.values(messageLibrary).forEach(category => {
          currentMessages = currentMessages.concat(category);
        });
      } else {
        // 使用指定分类的消息
        currentMessages = [...(messageLibrary[currentCategory] || [])];
      }
    }

    // 获取自定义消息
    function getCustomMessages () {
      const customText = customMessagesInput.value.trim();
      if (!customText) return [];

      return customText.split('\n')
        .filter(line => line.trim().length > 0)
        .map(line => {
          return {
            text: line.trim(),
            emoji: "💫" // 默认表情
          };
        });
    }

    // 创建弹窗
    function createPopup () {
      if (popupCount >= totalPopupCount) {
        pausePopups();
        return;
      }

      // 检查当前可见弹窗数量
      if (visiblePopupCount >= maxVisiblePopups) {
        // 如果超过最大可见数量，移除最早的一个弹窗
        const oldestPopup = popupContainer.firstChild;
        if (oldestPopup) {
          oldestPopup.remove();
          visiblePopupCount--;
          updateVisibleCount();
        }
      }

      // 确保有消息可用
      if (currentMessages.length === 0) {
        return;
      }

      const popup = document.createElement('div');
      popup.className = 'popup';

      // 随机位置
      const left = Math.floor(Math.random() * (window.innerWidth - 200));
      const top = Math.floor(Math.random() * (window.innerHeight - 100));

      // 随机样式
      const messageIndex = Math.floor(Math.random() * currentMessages.length);
      const message = currentMessages[messageIndex];
      const color = colors[Math.floor(Math.random() * colors.length)];

      popup.style.cssText = `
                left: ${left}px;
                top: ${top}px;
                background: ${color};
                animation: fadeIn 0.5s ease-out;
            `;

      // 添加内容
      popup.innerHTML = `
                <div class="popup-emoji">${message.emoji}</div>
                <div class="popup-content">${message.text}</div>
                <div class="popup-close">×</div>
            `;

      popupContainer.appendChild(popup);
      visiblePopupCount++;
      updateCount(1);
      updateVisibleCount();
    }

    // 更新总生成计数器
    function updateCount (change) {
      popupCount += change;
      countElement.textContent = popupCount;
    }

    // 更新可见弹窗计数器
    function updateVisibleCount () {
      visibleCountElement.textContent = visiblePopupCount;
    }

    // 开始弹窗
    function startPopups () {
      if (isRunning) return;

      // 获取设置值
      totalPopupCount = parseInt(popupCountInput.value) || 100;
      popupSpeed = parseInt(popupSpeedInput.value) || 300;
      maxVisiblePopups = parseInt(maxVisibleInput.value) || 100;

      // 更新当前消息列表（包含自定义消息）
      updateCurrentMessages();

      // 更新显示
      updateTotalCountDisplay();

      isRunning = true;
      popupInterval = setInterval(() => {
        const now = performance.now();
        if (now - lastFrameTime >= frameInterval) {
          createPopup();
          lastFrameTime = now;
        }
      }, popupSpeed);
      toggleBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停生成';
    }

    // 暂停弹窗
    function pausePopups () {
      clearInterval(popupInterval);
      isRunning = false;
      toggleBtn.innerHTML = '<i class="fas fa-play"></i> 继续生成';
    }

    // 添加清除设置按钮（可选）
    const clearSettingsBtn = document.createElement('button');
    clearSettingsBtn.innerHTML = '<i class="fas fa-trash-alt"></i> 清除设置';
    clearSettingsBtn.style.marginTop = '10px';
    clearSettingsBtn.addEventListener('click', function () {
      if (confirm('确定要清除所有设置吗？')) {
        localStorage.removeItem('blessingPopupSettings');
        location.reload();
      }
    });
    document.getElementById('controlsPanel').appendChild(clearSettingsBtn);

    // 清除所有弹窗
    function clearPopups () {
      popupContainer.innerHTML = '';
      popupCount = 0;
      visiblePopupCount = 0;
      countElement.textContent = '0';
      updateVisibleCount();
    }

    // 自动隐藏控制
    function toggleAutoHide () {
      if (autoHideToggle.checked) {
        document.body.classList.add('auto-hide');
      } else {
        document.body.classList.remove('auto-hide');
      }
    }

    // 计数器显示控制
    function toggleCounter () {
      if (counterToggle.checked) {
        counter.style.display = 'block';
      } else {
        counter.style.display = 'none';
      }
    }

    // 初始化应用
    init();
  </script>
</body>

</html>
